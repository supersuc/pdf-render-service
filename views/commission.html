<!--交易风控-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= orderData.projectName%> <%= orderData.roomNo %></title>
  <link rel="stylesheet" href="<%= SITE_URL%>/css/commission.css">
  <%# watermark%>
  <script>
    const setWatermark = (str) => {
      let id = '1.23452384164.123412415'

      if (document.getElementById(id) !== null) {
        document.body.removeChild(document.getElementById(id))
      }

      let can = document.createElement('canvas')
      can.width = 350
      can.height = 120

      let cans = can.getContext('2d')
      cans.rotate(-20 * Math.PI / 180)
      cans.font = '15px Vedana'
      cans.fillStyle = 'rgba(0, 0, 0, 0.07)'
      cans.textAlign = 'left'
      cans.textBaseline = 'Middle'
      cans.fillText(str, can.width / 20, can.height )

      let div = document.createElement('div')
      div.id = id
      div.style.pointerEvents = 'none'
      div.style.top = '3px'
      div.style.left = '0px'
      div.style.position = 'fixed'
      div.style.zIndex = '100000'
      div.style.width = document.documentElement.clientWidth  + 'px'
      div.style.height = document.documentElement.clientHeight  + 'px'
      div.style.background = 'url(' + can.toDataURL('image/png') + ') left top repeat'
      document.body.appendChild(div)
    }
  </script>
  <%# filters %>
  <%
    const datetime = (date = new Date(), format = 'YYYY-MM-DD HH:mm:ss') => {
      const fn = (d) => {
        return ('0' + d).slice(-2)
      }

      const d = new Date(date)
      const formats = {
        YYYY: d.getFullYear(),
        MM: fn(d.getMonth() + 1),
        DD: fn(d.getDate()),
        HH: fn(d.getHours()),
        mm: fn(d.getMinutes()),
        ss: fn(d.getSeconds())
      }



      return format.replace(/([a-z])\1+/ig, a => {
        return formats[a] || a
      })
    }
    const getFileName = (url) => {
      if(!url) return;
      let fileName = url.slice(url.lastIndexOf('/'));
      fileName = fileName.slice(1, fileName.lastIndexOf('.'));
      return fileName;
    }
    var riskCause = function ({report,limitReport,limitFinish,towElement,prepareRead, groupReportDayDealRisk,nameChange,phoneChange,reportValidlyChange,nameChangeCustomer = [],phoneChangeCustomer = [], visitBeforeRegister}) {
      let cause = [];
      if(report && JSON.parse(report)){
          cause.push('未提前报备')
      }
      if(limitReport && JSON.parse(limitReport)){
          cause.push('超出报备保护期')
      }
      if(limitFinish && JSON.parse(limitFinish)){
          cause.push('超出成交保护期')
      }
      if(towElement && JSON.parse(towElement)){
          cause.push('运营商三要素：手机号与客户不匹配')
      }
      if(prepareRead && JSON.parse(prepareRead)){
          cause.push('登记时间内无到访')
      }
      if(visitBeforeRegister && JSON.parse(visitBeforeRegister)){
          cause.push('登记前到访')
      }
      console.log('groupReportDayDealRisk', groupReportDayDealRisk);
      if(groupReportDayDealRisk && JSON.parse(groupReportDayDealRisk)){
          cause.push('报备当天成交')
      }
      if(nameChange && JSON.parse(nameChange)){
          if(nameChangeCustomer.length){
              cause.push(`${nameChangeCustomer[0]} 客户姓名变更`)
          }else{
              cause.push('客户姓名变更')
          }
      }
      if(phoneChange && JSON.parse(phoneChange)){
          if(phoneChangeCustomer.length){
              cause.push(`${phoneChangeCustomer[0]} 客户手机号变更`)
          }else{
              cause.push('客户手机号变更')
          }
      }
      if(reportValidlyChange && JSON.parse(reportValidlyChange)){
          cause.push('人工更改无效线索为有效')
      }

      let str = cause.join('，')
      return  str
    }

    var riskStatus = function(val){
      let Enum={
          RISK:'风险', NORMAL:'正常', UNKNOWN:'未知', NO_FRESHCARD:'未刷证',MULTI_CHANNEL:'多渠道'
      }
      return Enum[val]
    }

    var riskStatusCustomerFilter = function (val) {
      let Enum={
          RISK:'风险客户', NORMAL:'正常客户', UNKNOWN:'未知客户', NO_FRESHCARD:'未刷证'
      }
      return Enum[val]
    }

    var riskApproveStatus = function(val){
      let Enum={
          RISK:'风险', NORMAL:'正常', UNKNOWN:'未知', NO_FRESHCARD:'未刷证',MULTI_CHANNEL:'多渠道'
      }
      return Enum[val]
    }

    // 认证方式
    const proveTypeFilter = (val) => {
      const customerProveType = {
        PICTURE:'图片导入',
        WITNESS_CARD_MACHINE:'人证机认证',
        PHONE:'手机认证'
      };
      return customerProveType[val]
    }

    // 计算认证状态
  const approved = (item) => {
    let statu = '';
    if (item.hasPass == 'true') {
      statu = '成功'
    } else if (item.hasPass == 'false' && item.approved == 'true') {
     statu = '复核成功'
    } else if (item.hasPass == 'false') {
      statu = '失败'
    }
    return statu
  }

    const snapTypeFilter = (val) => {
        if (val == 'WITNESS_CARD_MACHINE') {
            return '人证机抓拍'
        } else if (val == 'MANUAL') {
            return '手动添加'
        }
    }

    const trackTypeFilter = (typeName, item) => {
      if (typeName == 'CHANNEL_REPORT_DELETE') {
        return '报备过期';
      }
      if (typeName == 'FRESH_CARD') {
        return '客户认证';
      }
      if (typeName == 'ARRIVE') {
        let backTip = '登记到访';
        orderData.customerInfos.forEach((el) => {
          if(el.firstReadTime == datetime(Number(item.data.arrivedTime))){
            backTip = '有效最新登记到访时间';
          }
        })
        return backTip;
      }
      if (typeName == 'SIGN' || typeName =='SIGN_TRADE') {
        return '客户签约';
      }
      if (typeName == 'SUBSCRIBE' || typeName =='SUBSCRIBE_TRADE') {
        return '客户认购';
      }
      if (typeName == 'CAMERA') {
        return '客户到访';
      }
      if (typeName == 'REPORT') {
        return '渠道报备';
      }
      if (typeName == 'CHANNEL_REPORT_UPDATE') {
        return '报备修改';
      }
      if (typeName == 'RECOGNITION_CHIP' ||typeName == 'RECOGNITION_CHIP_TRADE') {
        return '客户认筹';
      }
      if (typeName == 'CALL_IN') {
        return '客户来电';
      }
      if (typeName == 'CALL_OUT') {
        return '客户去电';
      }
      if (typeName == 'PHONE_CHANGE') {
        return '客户手机号变更';
      }
      if (typeName == 'REPORT_VALIDLY_CHANGE') {
        return '人工更改无效线索为有效';
      }
      if (typeName == 'NAME_CHANGE') {
        return '客户姓名变更';
      }
    }

    const confidenceFilter = (val) => {
      if(val === 'high'){
        return '高'
      }else if(val === 'medium'){
        return  '中'
      }else{
        return  '低'
      }
    }

    const validFilter = function (val) {
      if(typeof val == 'boolean'){
        return val
      }else if(typeof val == 'string'){
        if(val == 'true'){
          return true
        }else if(val == 'false'){
          return false
        }
      }
    }

    const getFlagText = (item)=>{
      const REPORT_MAP = {
        VALID_REPORT: '(有效报备)',
        INVALID_REPORT: '(无效报备)',
        EXPIRED_REPORT: '(失效：报备过期)',
        DUPLICATE_REPORT: '(失效：重复报备)',
        UNKNOWN: '',
      }
      return REPORT_MAP[item.data.reportType]
    }
    // const getFlagText = (item)=>{
    //   return
    //   const { valid, expire} = item.data
    //   const last = item.last
    //   if(last && valid){
    //     return
    //   }
    //   if (valid === false || valid === 'false') {
    //     return '(无效报备)'
    //   }
    //   if(expire && new Date(expire) < new Date()){
    //     return '(报备过期)'
    //   }
    //   if(typeof valid === 'undefined'){
    //     return '(有效报备)'
    //   }
    //   return valid ? '(有效报备)' : '(无效报备)'
    // }
  %>
</head>
<body class="py-20">
<div class="w-card">
  <h1 class="f-18 text-center page__title">
    <span><%= orderData.projectName %></span>
    <span class="ml-15"><%= orderData.roomNo  %></span>
  </h1>
</div>
<div class="w-card mt-15 px-15 pb-20">
  <h2 class="head f-14 pt-15 pb-10">交易信息</h2>
  <table class="w-table mt-15" width="100%">
    <thead>
      <tr>
        <th>房号</th>
        <th>签约时间</th>
        <th>认购时间</th>
        <th>渠道名称</th>
        <th>交易客户</th>
        <th>置业顾问</th>
        <th>交易状态</th>
        <th>交易风险</th>
        <% if (orderData.ruleType == 'TIMELINE') { %>
        <th>风险原因</th>
        <% } %>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td class="break-all"> <%= orderData.roomNo %> </td>
        <td><%= orderData.finishTime%></td>
        <td><%= orderData.subscriptionTime%></td>
        <td>
          <% if( orderData.riskStatus === 'MULTI_CHANNEL' ) { %>
            <%= '多渠道报备' %>
          <% } else { %>
            <%= orderData.channelCompany %>
          <% } %>
        </td>
        <td>
            <% if (orderData.customerInfos) {
              var customers = orderData.customerInfos.map(item => {
                return item.customerName;
              }).join('/')
            } %>
            <%= customers %>
        </td>
        <td><%= orderData.salerName%></td>
        <td>
          <% var orderStatus = function(val) {
            var Enum={
                FINISH:'签约', SUBSCRIPTION:'认购'
            }
            return Enum[val];
          } %>
          <%= orderStatus(orderData.orderStatus)%>
        </td>
        <td>
          <% if(orderData.riskStatus === 'RISK') { %>
            <span class="w-tag w-tag--danger"><%= riskStatus(orderData.riskStatus) %></span>
          <% } else if(orderData.riskStatus === 'NORMAL') {%>
            <span class="w-tag w-tag--success"><%= riskStatus(orderData.riskStatus) %></span>
          <% } else if(orderData.riskStatus === 'UNKNOWN') {%>
            <span class="w-tag w-tag--info"><%= riskStatus(orderData.riskStatus) %></span>
          <% } else if(orderData.riskStatus === 'NO_FRESHCARD') {%>
            <span class="w-tag w-tag--warning"><%= riskStatus(orderData.riskStatus) %></span>
          <% } else if(orderData.riskStatus === 'MULTI_CHANNEL') {%>
            <span class="w-tag w-tag--warning"><%= riskStatus(orderData.riskStatus) %></span>
          <% } %>
        </td>
        <%# 风险原因 Start%>
        <% if (orderData.ruleType == 'TIMELINE') { %>
        <td>
          <% if (orderData.riskStatus == 'RISK') { %>
            <%= riskCause({
              report: orderData.groupPrepareReportRisk,
              limitReport: orderData.groupLimitReportRisk,
              limitFinish: orderData.groupLimitFinishRisk,
              towElement: orderData.groupTwoElementsRisk,
              prepareRead: orderData.groupPrepareReadRisk,
              visitBeforeRegister: orderData.groupVisitBeforeRegisterRisk,
              groupReportDayDealRisk: orderData.groupReportDayDealRisk,
              phoneChange: orderData.groupPhoneChangeRisk,
              nameChange: orderData.groupNameChangeRisk,
              reportValidlyChange: orderData.groupReportValidlyChangeRisk,
            })%>
          <% } %>
        </td>
        <% } %>
        <%# 风险原因 End%>
      </tr>
    </tbody>
  </table>
</div>
<div class="w-card mt-15 px-15 pb-20">
  <h2 class="head f-14 pt-15 pb-10">客户信息</h2>
  <table class="w-table mt-15" width="100%">
    <colgroup>
      <col width="">
      <col>
      <col>
      <col width="200">
      <col>
      <% if (orderData.ruleType !== 'TIMELINE') { %>
      <col>
      <col>
      <% } %>
    </colgroup>
    <thead>
      <tr>
        <th>客户认证图片</th>
        <th>客户姓名</th>
        <th>报备时间</th>
        <th>证件号码</th>
        <th>首次到访时间</th>
        <th>认证时间</th>
        <th>电话号码</th>
        <% if (orderData.ruleType !== 'TIMELINE') { %>
        <th>客户风险</th>
        <th>风险原因</th>
        <% } %>
      </tr>
    </thead>
    <tbody>
      <% orderData.customerInfos.forEach(function(item){ %>
        <tr>
          <td>
            <img class="avatar" width="100" height="100" object-fit="contain" src="<%if(item.faceImage){%><%= item.faceImage %><%} else {%><%= `${SITE_URL}/img/avatar.png`%><%}%>" alt="">
          </td>
          <td><%= item.customerName%></td>
          <td><%= item.reportTime || '/'%></td>
          <td><%= item.idNumber%></td>
          <td><%= item.firstPhotoTime%></td>
          <td><%= item.verifyTime%></td>
          <td><%= item.phone%></td>
          <% if (orderData.ruleType !== 'TIMELINE') { %>
          <td>
            <%# 输出风险标签 Start %>
            <% if(item.riskStatus === 'RISK') { %>
            <span class="w-tag w-tag--danger"><%= riskStatus(item.riskStatus) %></span>
            <% } else if(item.riskStatus === 'NORMAL') {%>
              <span class="w-tag w-tag--success"><%= riskStatus(item.riskStatus) %></span>
            <% } else if(item.riskStatus === 'UNKNOWN') {%>
              <span class="w-tag w-tag--info"><%= riskStatus(item.riskStatus) %></span>
            <% } else if(item.riskStatus === 'NO_FRESHCARD') {%>
              <span class="w-tag w-tag--warning"><%= riskStatus(item.riskStatus) %></span>
            <% } else if(item.riskStatus === 'MULTI_CHANNEL') {%>
              <span class="w-tag w-tag--warning"><%= riskStatus(item.riskStatus) %></span>
            <% } %>
            <%# 输出风险标签 End %>
          </td>
          <td>
            <%= riskCause({
              report: item.prepareReportRisk,
              limitReport: item.limitReportRisk,
              limitFinish: item.limitFinishRisk,
              towElement: item.twoElementsRisk,
              prepareRead: item.prepareReadRisk,
              visitBeforeRegister: item.visitBeforeRegisterRisk,
              visitBeforeRegister: item.visitBeforeRegisterRisk,
              groupReportDayDealRisk: item.reportDayDealRisk,
              phoneChange: item.phoneChangeRisk,
              nameChange: item.nameChangeRisk,
              reportValidlyChange: item.reportValidlyChangeRisk,
            })%>
          </td>
          <% } %>
        </tr>
      <% })%>
    </tbody>
  </table>
</div>
<div class="w-card mt-15 px-15 pb-20">
  <h2 class="head f-14 pt-15 pb-10">风险结论</h2>
  <table class="w-table mt-15 w-table--no-border" width="100%">
    <colgroup>
      <col width="">
      <col>
      <col width="320">
      <col>
    </colgroup>
    <tbody>
      <tr>
        <td>
          <span class="text-info mr-10">系统判定结果</span>
          <%# 输出风险标签 Start %>
          <% if(orderData.riskStatus === 'RISK') { %>
            <span class="text-danger"><%= riskStatus(orderData.riskStatus) %></span>
          <% } else if(orderData.riskStatus === 'NORMAL') {%>
            <span class="text-success"><%= riskStatus(orderData.riskStatus) %></span>
          <% } else if(orderData.riskStatus === 'UNKNOWN') {%>
            <span><%= riskStatus(orderData.riskStatus) %></span>
          <% } else if(orderData.riskStatus === 'NO_FRESHCARD') {%>
            <span class="text-warning"><%= riskStatus(orderData.riskStatus) %></span>
          <% } else if(orderData.riskStatus === 'MULTI_CHANNEL') {%>
            <span class="text-warning"><%= riskStatus(orderData.riskStatus) %></span>
          <% } %>
          <%# 输出风险标签 End %>
        </td>
        <td>
          <span class="text-info mr-10">人工复核结果</span>
          <% if(orderData.riskApproveStatus === 'RISK') { %>
            <span class="text-danger"><%= riskApproveStatus(orderData.riskApproveStatus) %></span>
          <% } else if(orderData.riskApproveStatus === 'NORMAL') {%>
            <span class="text-success"><%= riskApproveStatus(orderData.riskApproveStatus) %></span>
          <% } else if(orderData.riskApproveStatus === 'UN_APPROVE') {%>
            <span class="text-warning"><%= riskApproveStatus(orderData.riskApproveStatus) %></span>
          <% } else if(orderData.riskApproveStatus === 'NO_FRESHCARD') {%>
            <span class="text-warning"><%= riskApproveStatus(orderData.riskApproveStatus) %></span>
          <% } %>
        </td>
        <td>
          <div class="d-flex align-center">
            <span class="text-info mr-10 flex-shrink-0">风险原因</span>
            <% if (orderData.riskStatus == 'RISK') { %>
              <% if (orderData.ruleType == 'TIMELINE') { %>
                <span class="text-danger">
                <%= riskCause({
                  report: orderData.groupPrepareReportRisk,
                  limitReport: orderData.groupLimitReportRisk,
                  limitFinish: orderData.groupLimitFinishRisk,
                  towElement: orderData.groupTwoElementsRisk,
                  prepareRead: orderData.groupPrepareReadRisk,
                  visitBeforeRegister: orderData.groupVisitBeforeRegisterRisk,
                  groupReportDayDealRisk: orderData.groupReportDayDealRisk,
                  phoneChange: orderData.groupPhoneChangeRisk,
                  nameChange: orderData.groupNameChangeRisk,
                  reportValidlyChange: orderData.groupReportValidlyChangeRisk,
                })%>
                </span>

              <% } else { %>
                <div class="d-flex flex-column">
                <% orderData.customerInfos.forEach(function(item){ %>
                  <% if (item.riskStatus == 'RISK') { %>
                    <span class="text-danger">
                    <%= item.customerName%>：
                    <%= riskCause({
                      report: item.prepareReportRisk,
                      limitReport: item.limitReportRisk,
                      limitFinish: item.limitFinishRisk,
                      towElement: item.twoElementsRisk,
                      prepareRead: item.prepareReadRisk,
                      visitBeforeRegister: item.visitBeforeRegisterRisk,
                      visitBeforeRegister: item.visitBeforeRegisterRisk,
                      groupReportDayDealRisk: item.reportDayDealRisk,
                      phoneChange: item.phoneChangeRisk,
                      nameChange: item.nameChangeRisk,
                      reportValidlyChange: item.reportValidlyChangeRisk,
                    })%>
                    </span>
                  <% } %>
                <% }) %>
                </div>
              <% } %>
            <% } %>
          </div>
        </td>
        <td>
          <span class="text-info mr-10">复核人</span><span><%= orderData.riskApproveUserName%></span>
        </td>
      </tr>
      <tr>
        <td>
          <span class="text-info mr-10">系统判定时间</span><span><%= orderData.determineTime%></span>
        </td>
        <td>
          <span class="text-info mr-10">人工复核时间</span><span><%= orderData.riskApproveTime%></span>
        </td>
        <td colspan="2">
          <span class="text-info mr-10">判定规则</span><span><%= orderData.riskRuleAlias%></span>
        </td>
      </tr>
      <tr>
        <td colspan="4">
          <div class="d-flex">
            <span style="width:6em;" class="text-info flex-shrink-0">复核备注</span>
            <div class="break-all ml-10"><%= orderData.riskApproveRemark%></div>
          </div>
        </td>
      </tr>
      <tr>
        <td colspan="4">
          <div class="d-flex">
            <span style="width:6em;" class="text-info flex-shrink-0">附件链接</span>
            <div class="ml-10 d-flex flex-wrap flex-auto">
            <% if (Array.isArray(locals.filesListData) && filesListData.length) {%>
              <% filesListData.forEach((item) => { %>
                <a href="<%= item.fileUrl%>" target="_blank" class="file-list__item d-flex align-center mr-20 text-primary"><i class="icon-file mr-5"></i> <span><%= getFileName(item.fileUrl)%></span></a>
              <%})%>
            <% } else { %>
              <%= '/'%>
            <% }%>
            </div>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</div>
<% if (orderData.ruleType != 'CUSTOMER') {%>
<div class="w-card mt-15 px-15 pb-20">
  <h2 class="head f-14 pt-15 pb-10">交易轨迹</h2>
  <div class="timeline d-flex flex-wrap justify-space-around<% if (!(orderData.groupRiskTrace && orderData.groupRiskTrace.length)) { %> <%= ' timeline--empty'%> <%}%>">
    <% orderData.groupRiskTrace && orderData.groupRiskTrace.forEach(function(item){ %>
    <div class="timeline__item text-center">
      <div class="py-10">
        <%= item.time%>
      </div>
      <div class="pt-25"><span class="text-info mr-10"><%= item.name%></span><span><%= item.typeText%></span></div>
      <% if(item.type == 'REPORT'){ %>
        <div class="mt-10"><span class="text-info mr-10">报备渠道：</span><span><%= item.channelCompany%></span></div>
      <%}%>
      <% if(item.type == 'VISIT_REGISTER' && item.arriveRegisterWay){ %>
        <div class="mt-10"><span class="text-info mr-10">登记类型：</span><span><%= item.arriveRegisterWay%></span></div>
      <%}%>
    </div>
    <%})%>
  </div>
</div>
<% } %>
<div class="w-card mt-15 px-15 pb-20">
  <h2 class="head f-14 pt-15 pb-10">客户完整轨迹</h2>
  <% if (typeof trackList !== 'undefined') {%>
    <% if (orderData.ruleType === 'TIMELINE') {%>
      <table class="w-table mt-15" width="100%">
        <colgroup>
          <col width="200">
          <col>
          <col>
          <col width="280">
          <col>
          <col width="140">
        </colgroup>
        <thead>
          <tr>
            <th>时间</th>
            <th>客户姓名</th>
            <th>记录类型</th>
            <th>记录详情</th>
            <th>记录来源</th>
            <th>轨迹图片</th>
          </tr>
        </thead>
        <tbody>
          <% trackList.forEach((item) => { %>
            <tr <% if (item.riskMark) { %>class="text-danger"<% } %>>
              <td><%= item.time%></td>
              <td><%= item.customerName%></td>
              <td>
                <%= trackTypeFilter(item.typeName, item)%>
              </td>
              <td>
                <% if (item.typeName == 'FRESH_CARD') { %>
                  <div>认证方式：<%= proveTypeFilter(item.proveType)%> 认证状态：<%= approved(item)%></div>
                <%}%>
                <% if (item.typeName == 'ARRIVE') { %>
                  <div>置业顾问：<%= item.data ? item.data.salerName : '' %></div>
                  <div><%= item.data && item.data.arriveRegisterWay ? '登记类型：' : '' %> <%= item.data ? item.data.arriveRegisterWay : '' %></div>
                  <div><%= item.data ? item.data.desc : '' %></div>
                <%}%>
                <% if (item.typeName == 'SIGN_TRADE' || item.typeName == 'SUBSCRIBE_TRADE') { %>
                  <div class="break-all"><% if(item.data.roomNo){%>成交房号：<%}%>
                    <%= item.data.roomNo ? item.data.roomNo : ''%>
                  </div>
                <%}%>
                <% if (['CHANNEL_REPORT_UPDATE', 'REPORT'].includes(item.typeName)) { %>
                  <% if (item.data.name) { %>
                    <div>客户姓名：<%= item.data.context?item.data.context.before.name:item.data.name?item.data.name:' '%></div>
                  <%}%>
                  <% if (item.data.mobile) { %>
                    <div>手机号码：<%= item.data.context?item.data.context.before.mobile:item.data.mobile?item.data.mobile:' '%></div>
                  <%}%>
                  <% if (item.data.agent) { %>
                    <div>经纪人：<%= item.data.agent%></div>
                  <%}%>
                  <% if (item.data.channelCompany) { %>
                    <div>渠道名称：<%= item.data.channelCompany%></div>
                  <%}%>
                  <% if (item.typeName === 'REPORT') { %>
                    <%= getFlagText(item) %>
                  <%}%>
                <% if (item.data.reportType === 'EXPIRED_REPORT' ) { %>
                <div>过期时间：<%= item.data.expire %></div>
                <%}%>
                <%}%>
                <% if (item.typeName === 'RECOGNITION_CHIP_TRADE') { %>
                <div>成交房号：<%= item.data.roomNo ? item.data.roomNo : '' %></div>
                <%}%>
                <% if (item.typeName === 'CAMERA') { %>
                  <div>匹配分值：<%= item.confidenceScore%> <%= confidenceFilter(item.confidence)%></div>
                <%}%>
                <% if (['PHONE_CHANGE', 'NAME_CHANGE'].includes(item.typeName)) { %>
                  <div><%= item.description%></div>
                <%}%>
                <% if (['REPORT_VALIDLY_CHANGE'].includes(item.typeName)) { %>
                  <div>无效原因：<%= item.description%></div>
                <%}%>
              </td>
              <td>
                <% if (item.typeName == 'FRESH_CARD') { %>
                  <div><%= proveTypeFilter(item.proveType)%></div>
                <%}%>
                <% if (['CAMERA', 'RECOGNITION_CHIP_TRADE'].includes(item.typeName)) { %>
                  <div><%= item.source%></div>
                <%}%>
                <% if (item.typeName == 'ARRIVE') { %>
                  <div><%= snapTypeFilter(item.proveType)%></div>
                <%}%>
              </td>
              <td>
                <% if (item.image) { %>
                  <img class="avatar" width="100" height="100" object-fit="contain" src="<%= item.image%>" alt="">
                <%}%>
              </td>
            </tr>
          <% })%>
          <% if (trackList.length === 0) { %>
            <tr>
              <td colspan="6">
                <div class="text-info text-center">暂无数据</div>
              </td>
            </tr>
          <% } %>
        </tbody>
      </table>
    <% } else { %>
      <% trackList.forEach((customer) => { %>
      <h3 class="f-14 pt-15">客户姓名：<%= customer.customerName%></h3>
      <table class="w-table mt-15" width="100%">
        <colgroup>
          <col width="200">
          <col>
          <col width="280">
          <col>
          <col width="140">
        </colgroup>
        <thead>
          <tr>
            <th>时间</th>
            <th>记录类型</th>
            <th>记录详情</th>
            <th>记录来源</th>
            <th>轨迹图片</th>
          </tr>
        </thead>
        <tbody>
          <% customer.list && customer.list.forEach((item) => { %>
            <tr <% if (item.riskMark) { %>class="text-danger"<% } %>>
              <td><%= item.time%></td>
              <td>
                <%= trackTypeFilter(item.typeName, item)%>
              </td>
              <td>
                <% if (item.typeName == 'FRESH_CARD') { %>
                  <div>认证方式：<%= proveTypeFilter(item.proveType)%> 认证状态：<%= approved(item)%></div>
                <%}%>
                <% if (item.typeName == 'ARRIVE') { %>
                  <div>置业顾问：<%= item.data ? item.data.salerName : '' %></div>
                  <div><%= item.data && item.data.arriveRegisterWay ? '登记类型：' : '' %> <%= item.data ? item.data.arriveRegisterWay : '' %></div>
                <%}%>
                <% if (item.typeName == 'SIGN' || item.typeName == 'SUBSCRIBE') { %>
                <div class="break-all"><% if(item.data.roomNo){ %>成交房号：<%}%>
                  <%= item.data.roomNo ? item.data.roomNo : ''%>
                </div>
                <%}%>
                <% if (['CHANNEL_REPORT_UPDATE', 'REPORT'].includes(item.typeName)) { %>
                  <% if (item.data.name) { %>
                    <div>客户姓名：<%= item.data.context?item.data.context.before.name:item.data.name?item.data.name:' '%></div>
                  <%}%>
                  <% if (item.data.mobile) { %>
                    <div>手机号码：<%= item.data.context?item.data.context.before.mobile:item.data.mobile?item.data.mobile:' '%></div>
                  <%}%>
                  <% if (item.data.agent) { %>
                    <div>经纪人：<%= item.data.agent%></div>
                  <%}%>
                  <% if (item.data.channelCompany) { %>
                    <div>渠道名称：<%= item.data.channelCompany%></div>
                  <%}%>
                  <% if (item.data.reportType) { %>
                     <div><%= getFlagText(item) %></div>
                  <%}%>
                <% if (item.data.reportType === 'EXPIRED_REPORT' ) { %>
                <div>过期时间：<%= item.data.expire %></div>
                <%}%>
                <%}%>
                <% if (['PHONE_CHANGE', 'NAME_CHANGE'].includes(item.typeName)) { %>
                  <div><%= item.description%></div>
                <%}%>
                <% if (['REPORT_VALIDLY_CHANGE'].includes(item.typeName)) { %>
                  <div>无效原因：<%= item.description%></div>
                <%}%>

                <% if (item.typeName === 'RECOGNITION_CHIP_TRADE') { %>
                <div>成交房号：<%= item.data.roomNo ? item.data.roomNo : '' %></div>
                <%}%>
                <% if (item.typeName === 'CAMERA') { %>
                  <div>匹配分值：<%= item.confidenceScore%> <%= confidenceFilter(item.confidence)%></div>
                <%}%>
              </td>
              <td>
                <% if (item.typeName == 'FRESH_CARD') { %>
                  <div><%= proveTypeFilter(item.proveType)%></div>
                <%}%>
                <% if (['CAMERA', 'RECOGNITION_CHIP_TRADE'].includes(item.typeName)) { %>
                  <div><%= item.source%></div>
                <%}%>
                <% if (item.typeName == 'ARRIVE') { %>
                  <div><%= snapTypeFilter(item.proveType)%></div>
                <%}%>
              </td>
              <td>
                <% if (item.image) { %>
                  <img class="avatar" width="100" height="100" object-fit="contain" src="<%= item.image%>" alt="">
                <%}%>
              </td>
            </tr>
          <% })%>
          <% if (trackList.length === 0) { %>
            <tr>
              <td colspan="6">
                <div class="text-info text-center">暂无数据</div>
              </td>
            </tr>
          <% } %>
        </tbody>
      </table>
      <% })%>
    <% } %>
  <% } %>
</div>

<% if (orderData.reportCreateTime) {%>
<div class="w-card mt-15 pa-15">
  <span class="text-info mr-15">报告生成时间</span> <%= orderData.reportCreateTime%>
</div>
<% } %>
<% if (typeof waterMark !== 'undefined') {%>
<script>
  setWatermark('<%= waterMark%>');
</script>
<% } %>
</body>
</html>
